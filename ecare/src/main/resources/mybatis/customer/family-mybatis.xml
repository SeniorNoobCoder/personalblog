<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecare.web.customer.family">
    
    
	<!--查询信息列表-->
    <select id="findListPage" resultType="pd" parameterType="page">
		SELECT
			a.id,
			a.login_name,
			a.login_password,
			a.sex,
			a.`status`,
			a.phone,
			a.live_address,
			a.birth_address,
			a.head_address,
			a.session_id,
			a.remark,
			a.remove_logo,
			a.create_time,
			a.update_time,
			a.email,
			a.isAuthent,
			a.user_type,
			a.is_work,
			a.nickname
		FROM
			app_users a
		WHERE a.user_type = 'family'
    	 <if test="pd.login_name != null and pd.login_name != ''">
			and a.login_name=#{pd.login_name}
		</if>
		<if test="pd.login_password != null and pd.login_password != ''">
			and a.login_password=#{pd.login_password}
		</if>
		<if test="pd.nickname != null and pd.nickname != ''">
			and a.nickname like concat('%', #{pd.nickname},'%')
		</if>
		<if test="pd.status != null and pd.status != ''">
			and a.status=#{pd.status}
		</if>
		order by  a.create_time desc
    </select>

	<select id="findList" resultType="pd" parameterType="pd">
		SELECT
			id
		FROM
			app_users
		WHERE user_type = 'family' AND remove_logo = 'N' AND `status` = '1'
	</select>

	<select id="findListByFamilyId" parameterType="pd" resultType="pd">
		SELECT
			a.id,
			a.family_id,
			a.device_id,
			a.sn,
			a.create_time,
			a.relationship,
			b.`name`,
			b.address,
			b.phone
		FROM
			customer_family_device a
		LEFT JOIN customer_user b ON a.sn = b.sn
		WHERE
			family_id = #{id}
	</select>
	<select id="findListBySn" parameterType="pd" resultType="pd">
		SELECT
			a.relationship,
			b.phone,
			b.live_address
		FROM
			customer_family_device a
		LEFT JOIN app_users b ON a.family_id = b.id
		WHERE
			sn =#{sn}
	</select>
	<!--查询信息详情-->
    <select id="findInfo" resultType="pd" parameterType="pd">
		SELECT
			a.id,
			a.login_name,
			a.login_password,
			a.sex,
			a.`status`,
			a.phone,
			a.live_address,
			a.birth_address,
			a.head_address,
			a.session_id,
			a.remark,
			a.remove_logo,
			a.create_time,
			a.update_time,
			a.email,
			a.isAuthent,
			a.user_type,
			a.is_work,
			a.nickname
		FROM
			app_users a
    	 where 1=1
    	 <if test="id != null and id != '' ">
			and a.id=#{id}
		</if>
		<if test="login_name != null and login_name != '' ">
			and a.login_name=#{login_name}
		</if>
    </select>
    

    <!--保存信息-->
    <insert id="save" parameterType="pd">
    	insert into customer_family (
    			login_name,
    			login_password,
    			user_name,
    			sex,
    			phone,
    			birth_date,
    			live_address,
    			birth_address,
    			head_address,
    			digital_account,
    			type,
    			status,
    			remark,
    			session_id,
    			remove_logo,
    			create_user,
    			create_time,
    			update_time) 
    		values (
    			#{login_name},
    			#{login_password},
    			#{user_name},
    			#{sex},
    			#{phone},
    			#{birth_date},
    			#{live_address},
    			#{birth_address},
    			#{head_address},
				#{digital_account},
				#{type},
				#{status},
				#{remark},
				#{session_id},
				#{remove_logo},
				#{create_user},
				#{create_time},
				#{update_time})
    </insert>
    

	<!--更新信息-->
    <update id="update" parameterType="pd">
    	update app_users set
		<if test="status != null and status != '' ">
			status=#{status},
		</if>
		<if test="remove_logo != null and remove_logo != '' ">
			remove_logo=#{remove_logo},
		</if>
		update_time=#{update_time}
		where id=#{id}
    </update>
    
    
	<!--删除信息-->
    <delete id="delete" parameterType="String">
    	delete from app_users where id=#{id}
    </delete>
    
    <delete id="deleteFamilyDevice" parameterType="String">
    	delete from customer_family_device where family_id=#{id}
    </delete>
    
    
	<!--查询已删除信息数量-->
    <select id="findDelNum" parameterType="pd" resultType="Integer">
    	select count(*) from customer_family where remove_logo='Y'
    </select>
    
    
    <!--查询已删除用户ids-->
    <select id="findListIds" parameterType="pd" resultType="Integer">
    	select 
    		a.id as "id"
    	 from customer_family a
    	 where a.remove_logo='Y'
    </select>
    
    
    <select id="findDeviceList" parameterType="pd" resultType="pd">
    	select
    		a.id as "id",
    		a.family_id as "family_id",
    		a.device_id as "device_id",
    		a.relationship as "relationship",
    		a.create_time as "create_time",
    		b.sn as "sn",
    		b.app_id as "app_id",
    		b.secret as "secret",
    		c.name as "name",
    		c.sex as "sex",
    		c.phone as "phone",
    		c.birthday as "birthday",
    		c.address as "address",
    		c.health_condition as "health_condition"
    		from customer_family_device a
    		left join customer_device b on a.device_id=b.id
    		left join customer_user c on c.device_id=a.device_id
    		where a.family_id=#{id}
    </select>
    
    
</mapper>