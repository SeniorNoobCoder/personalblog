<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecare.web.partners.business">
    
    
	<!--查询信息列表-->
    <select id="findListPage" resultType="pd" parameterType="page">
		SELECT
			a.id,
			a.login_name,
			a.login_password,
			a.sex,
			a.`status`,
			a.phone,
			a.live_address,
			a.birth_address,
			a.head_address,
			a.session_id,
			a.remark,
			a.remove_logo,
			a.create_time,
			a.update_time,
			a.email,
			a.isAuthent,
			a.user_type,
			a.is_work,
			b.partner_id,
			b.partner_code,
			b.authent_name,
			b.PID,
			b.idCard_front,
			b.idCard_back,
			b.step,
			d.authent_name AS companyName
		FROM
		app_users a
		LEFT JOIN app_users_authent b ON a.id = b.business_id
		LEFT JOIN partner_user_authent d ON b.partner_id = d.partner_id
		where a.remove_logo = 'N' AND a.user_type = 'server'
    	 <if test="pd.partner_id != null and pd.partner_id != ''">
			and b.partner_id=#{pd.partner_id}
		</if>
		<if test="pd.partner_code != null and pd.partner_code != ''">
			and b.partner_code=#{pd.partner_code}
		</if>
		<if test="pd.login_name != null and pd.login_name != ''">
			and a.login_name=#{pd.login_name}
		</if>
		<if test="pd.authent_name != null and pd.authent_name != ''">
			and b.authent_name like concat('%', #{pd.authent_name},'%')
		</if>
		<if test="pd.status != null and pd.status != ''">
			and a.status=#{pd.status}
		</if>
		<if test="pd.isAuthent != null and pd.isAuthent != ''">
			and a.isAuthent=#{pd.isAuthent}
		</if>
		order by a.status DESC , a.create_time DESC
    </select>

	<!--查询信息列表-->
	<select id="findList" resultType="pd" parameterType="pd">
		SELECT
			id
		FROM
			app_users
		WHERE
			user_type = 'server'
			AND remove_logo = 'N'
			AND isAuthent = 'Y'
			AND status = '1'
	</select>
	<!--查询工作中商户的信息列表-->
	<select id="findBusinessIsWorkList" resultType="pd" parameterType="pd">
		SELECT
			b.session_id
		FROM
			app_users_server_category a
		LEFT JOIN app_users b ON a.business_id = b.id
		WHERE  b.user_type = 'server' AND b.status = '1' AND b.is_work = '1' AND b.isAuthent = 'Y'
		<if test="server_category_id != null and server_category_id != '' ">
			AND	a.category_id=#{server_category_id}
		</if>
	</select>
	<!--查询信息详情-->
    <select id="findInfo" resultType="pd" parameterType="pd">
    	SELECT
			a.id,
			a.login_name,
			a.nickname,
			a.login_password,
			a.sex,
			a.`status`,
			a.phone,
			a.live_address,
			a.birth_address,
			a.head_address,
			a.session_id,
			a.remark,
			a.remove_logo,
			a.create_time,
			a.update_time,
			a.email,
			a.isAuthent,
			a.user_type,
			b.partner_id,
			b.partner_code,
			b.authent_name,
			b.PID,
			b.idCard_front,
			b.idCard_back,
			b.create_time,
			b.update_time,
			b.step
			from app_users a
				LEFT JOIN
			app_users_authent b
				ON a.id = b.business_id
		where a.id=#{id}
    </select>
	<!--查询信息详情-->
	<select id="findInfoByLoginName" resultType="pd" parameterType="pd">
		SELECT
		a.id,
		a.login_name,
		a.login_password,
		a.sex,
		a.`status`,
		a.phone,
		a.live_address,
		a.birth_address,
		a.head_address,
		a.session_id,
		a.remark,
		a.remove_logo,
		a.create_time,
		a.update_time,
		a.email,
		a.isAuthent,
		a.user_type,
		a.is_work,
		b.partner_id,
		b.partner_code,
		b.authent_name,
		b.PID,
		b.idCard_front,
		b.idCard_back,
		b.step
		from app_users a
		left join app_users_authent b on a.id=b.business_id
		where a.login_name=#{login_name}
	</select>


	<!--更新信息-->
    <update id="update" parameterType="pd">
    	update app_users set
    		<if test="login_name != null and login_name != '' ">
				login_name=#{login_name},
			</if>
			<if test="login_password != null and login_password != '' ">
				login_password=#{login_password},
			</if>
			<if test="user_name != null and user_name != '' ">
				user_name=#{user_name},
			</if>
			<if test="sex != null and sex != '' ">
				sex=#{sex},
			</if>
			<if test="phone != null and phone != '' ">
				phone=#{phone},
			</if>
			<if test="birth_date != null and birth_date != '' ">
				birth_date=#{birth_date},
			</if>
			<if test="live_address != null and live_address != '' ">
				live_address=#{live_address},
			</if>
			<if test="birth_address != null and birth_address != '' ">
				birth_address=#{birth_address},
			</if>
			<if test="head_address != null and head_address != '' ">
				head_address=#{head_address},
			</if>
			<if test="status != null and status != '' ">
				status=#{status},
			</if>
			<if test="remark != null and remark != '' ">
				remark=#{remark},
			</if>
    		<if test="remove_logo != null and remove_logo != '' ">
				remove_logo=#{remove_logo},
			</if>
			<if test="session_id != null and session_id != '' ">
				session_id=#{session_id},
			</if>
    		update_time=#{update_time}
    		where id=#{id}
    </update>
    
    
	<!--删除信息-->
    <delete id="delete" parameterType="String">
    	delete from app_users where id=#{id}
    </delete>
    
    
    
    <select id="findAuthent" parameterType="pd" resultType="pd">
    	select
    		a.id as "id",
    		a.business_id as "business_id",
    		a.authent_type as "authent_type",
    		a.authent_code as "authent_code",
    		a.authent_name as "authent_name",
    		a.authent_photo1 as "authent_photo1",
    		a.authent_photo2 as "authent_photo2",
    		a.authent_photo3 as "authent_photo3",
    		a.remark as "remark",
    		a.create_user as "create_user",
    		a.create_time as "create_time",
    		a.update_time as "update_time"
    		
    		from partner_business_authent a
    		where a.business_id=#{business_id}
    </select>

	<select id="findServerCategory" parameterType="pd" resultType="pd">
		SELECT
		a.id AS "id",
		a. NAME AS "name",
		a.parent_id AS "pId"
		FROM
		app_users_server_category pusc
		LEFT JOIN server_category a
		ON pusc.category_id = a.id
		WHERE
		1 = 1
		AND pusc.business_id = #{id}
		AND a.remove_logo = 'N'
		ORDER BY
		a.order_by ASC,
		a.create_time DESC
	</select>
	<select id="findNum" parameterType="pd" resultType="Integer">
		SELECT
		COUNT(0) AS num
		FROM
		app_users a
		WHERE user_type = 'server'
		<if test="remove_logo != null and remove_logo != '' ">
			AND a.remove_logo=#{remove_logo}
		</if>
	</select>
</mapper>