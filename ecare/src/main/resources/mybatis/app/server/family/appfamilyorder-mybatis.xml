<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecare.app.server.appfamily">
	
	<!-- 查询设备编号 -->
	<select id="findDeviceList" parameterType="pd" resultType="pd">
		SELECT
			a.id as "id",
			a.family_id as "family_id",
			a.device_id as "device_id",
			a.sn as "sn",
			a.relationship as "relationship"
		FROM
			customer_family_device a
		where 1=1 and a.family_id=#{family_id}
		
	</select>
	
	<!-- 查询家庭版订单列表 -->
	<select id="findFamilyOrderList"  parameterType="pd" resultType="pd">
		SELECT
			a.id AS id,
			a.appointment_time AS appointment_time,
			a.server_category_name AS server_category_name,
			a.customer_address AS customer_address,
			a.remark AS remark,
			a.`status` AS `status`,
			a.appointment_time as "appointment_time",
			a.customer_name AS customer_name,
			a.order_source AS order_source,
			a.others_server AS others_server,
			a.pay_type AS pay_type,
			d.head_address AS head_address,
			a.receiving AS receiving,
			a.server_user_id AS server_user_id,
			a.amount AS amount
		FROM
			customer_order a
		LEFT JOIN customer_family_device b ON a.customer_sn = b.sn
		LEFT JOIN app_users_authent c ON a.server_user_id = c.business_id
		LEFT JOIN partner_user d ON c.partner_id = d.id
		WHERE a.remove_logo = 'N'  and a.status !='9'
		<if test="family_id != null and family_id != '' ">
				and b.family_id =#{family_id}
			</if>
			<if test="status != null and status != '' and status != '-1' ">
				and a.status =#{status}
			</if>
				<if test="statusTwo != null and statusTwo != ''">
					and (a.status = #{statusTwo} OR a.status = #{statusThree} OR a.status = #{statusFour})
			</if>
			<if test="server_user_id != null and server_user_id != ''">
				and a.server_user_id = #{server_user_id}
			</if>
			<if test="customer_sn != null and customer_sn != ''">
				and a.customer_sn = #{customer_sn}
			</if>
				order by a.update_time desc
			<if test="endPage != null and endPage != ''">
	   			limit #{startPage},#{endPage}
   			</if>
	
	</select>
	
	
	<!-- 查询订单数量 -->
	<select id="findFamilyOrderNum" resultType="Integer" parameterType="pd">
		SELECT
			count(0)
		FROM
			customer_order a
		LEFT JOIN customer_family_device b ON a.customer_sn = b.sn
		LEFT JOIN app_users_authent c ON a.server_user_id = c.business_id
		LEFT JOIN partner_user d ON c.partner_id = d.id and a.status !='9'
		WHERE a.remove_logo = 'N' AND b.family_id = #{family_id}
			<if test="status != null and status != '' and status != '-1' ">
				and a.status =#{status}
			</if>
			<if test="statusTwo != null and statusTwo != ''">
				and (a.status = #{statusTwo} OR a.status = #{statusThree} OR a.status = #{statusFour})
			</if>
		
			<if test="server_user_id != null and server_user_id != ''">
				and a.server_user_id = #{server_user_id}
			</if>
			<if test="customer_sn != null and customer_sn != ''">
				and a.customer_sn = #{customer_sn}
			</if>
	
	</select>

	<!--取消订单  -->
	<update id="updateOrder" parameterType="pd">
			update customer_order set
			<if test="status != null and status != ''">
					status = #{status},
			</if>
			<if test="remove_logo != null and remove_logo != ''">
					remove_logo = #{remove_logo},
			</if>
			update_time=NOW()
			where id=#{id}
	</update>
	
	<!-- 查询商户信息 -->
	<select id="findUserList" parameterType="pd" resultType="pd">
			SELECT
				b.business_id as "id",
				a.login_name as "login_name",
				a.sex as "sex",
				a.status as "status",
				a.phone as "phone",
				a.live_address as "live_address",
				a.head_address as "head_address",
				a.remark as "remark",
				b.authent_name as "authent_name",
				a.email as "email"
			FROM
				app_users a 
				LEFT JOIN app_users_authent b on a.id=b.business_id
			where a.isAuthent="Y" and a.is_work='1' and a.status='1' and a.remove_logo="N"  and user_type="server"
			 and b.partner_id=#{partner_id}
	</select>
	
	
	<!-- 查询商户信息数量 -->
	<select id="findUserNum" parameterType="pd" resultType="Integer">
			SELECT
				count(*)
			FROM
				app_users a 
			where a.isAuthent="Y" and a.is_work='1' and a.status='1' and a.remove_logo="N"  and user_type="server"
	</select>
	
	<!-- 查询订单的状态 -->
	<select id="findStatusInfo" parameterType="pd" resultType="pd">
		SELECT
			a.id as "id",
			a.status as "status"
		FROM
			customer_order a
		where a.remove_logo='N' and a.id=#{id}
	</select>
	
	<!-- 获取订单详情 -->
	<select id="findOrderInfo"  parameterType="pd" resultType="pd">
		select
			a.id as "id",
			a.appointment_time AS "appointment_time",
			a.server_category_name as "server_category_name",
			a.customer_address as "customer_address",
			a.remark as "remark",
			a.customer_id as "customer_id",
			a.order_no as "order_no",
			a.server_info_id as "server_info_id",
			a.server_user_id as "server_user_id",
			a.customer_sn as "customer_sn",
			a.customer_phone as "customer_phone",
			a.customer_name as "customer_name",
			a.amount as "amount",
			a.pay_type as "pay_type",
			a.status as "status",
			a.order_no as "order_no",
			a.order_source AS "order_source",
			a.others_server AS "others_server"
			
		from
			customer_order a
			where 1=1  and a.id=#{id}
	
	</select>
	
		<!-- 根据订单编号查询点单流程 -->
	<select id="findFlowList" parameterType="pd" resultType="pd">
		SELECT
			a.order_no as "order_no",
			a.status as "status",
			a.create_time as "create_time"
		FROM
			customer_order_flow a where a.order_no=#{order_no}
		ORDER BY create_time desc
	</select>
	
	<!-- 查询商户信息 -->
	<select id="findMerchantInfo" parameterType="pd" resultType="pd">
		SELECT
			a.id AS id,
			a.`status` AS `status`,
			a.phone AS phone,
			a.live_address AS live_address,
			a.head_address AS head_address,
			b.authent_name AS authent_name,
			a.remark AS remark,
			d.authent_name AS companyName,
			c.address AS companyAddress,
			c.phone AS companyPhone
		FROM
			app_users a
			LEFT JOIN app_users_authent b  ON a.id =  b.business_id
			LEFT JOIN partner_user c ON c.id = b.partner_id
			LEFT JOIN partner_user_authent d ON c.id = d.partner_id
			where a.id=#{id}
	</select>
	
	<!-- 订单评价 -->
	<insert id="saveAssessment" parameterType="pd">
		insert into customer_order_assessment (
        order_no,
        is_punctuality,
        create_time,
        count,
        service_quality,
        service_attitude,
        server_info_id)
        values (
        #{order_no},
        #{is_punctuality},
       	NOW(),
       	#{count},
       	#{service_quality},
       	#{service_attitude},
       	#{server_info_id})
	</insert>
	
	<!-- 评价图片 -->
	<insert id="saveAssessmentImage" parameterType="pd">
		insert into customer_order_assessment_image (
        assessment_id,
        image_url,
        create_time)
        values (
        #{assessment_id},
        #{image_url},
       	NOW())
	</insert>
	
	<!-- 查询评价信息 -->
	<select id="findAssessmentInfo" parameterType="pd" resultType="pd">
		select a.id as "id"
		from customer_order a
		where a.order_no=#{order_no}
	</select>
	
	<!-- 根据编号查询评论id -->
		<select id="findAAssInfo" parameterType="pd" resultType="pd">
			SELECT
				a.id,
				a.order_no
				FROM
				customer_order_assessment a
			where a.order_no=#{order_no}
		</select>
	
		<!-- 查询服务次数级星级 -->
	<select id="findStatInfo" resultType="pd" parameterType="pd">
			SELECT
			a.server_user_id AS serverId,
			COUNT(0) as count,
			SUM(b.service_quality) AS quality
		FROM
			customer_order a
		LEFT JOIN customer_order_assessment b ON a.order_no = b.order_no
		LEFT JOIN app_users_authent c ON a.server_user_id = c.business_id
		LEFT JOIN partner_user d ON d.id = c.partner_id
		WHERE a.`status` in (4,5,6) and c.partner_id=#{partner_id} 
		GROUP BY a.server_user_id 
		ORDER BY count
	</select>
		
	<select id="findStat" resultType="pd" parameterType="pd">
		SELECT
			c.business_id as "id"
		FROM
			customer_order a
		LEFT JOIN customer_order_assessment b ON a.order_no = b.order_no
		LEFT JOIN app_users_authent c ON a.server_user_id = c.business_id
		LEFT JOIN partner_user d ON d.id = c.partner_id
		WHERE a.`status` in (4,5,6) and c.partner_id=#{partner_id} 
		GROUP BY a.server_user_id 
		ORDER BY count
	</select>	
</mapper>