<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecare.app.server.appmessage">
	
	<!-- 查询系统消息最新的消息  状态1为已发送的消息-->
	<select id="findMessageOneInfo" parameterType="pd" resultType="pd">
		SELECT a.*
			FROM common_message a
		LEFT JOIN common_message_user b on a.id=b.message_id
			where a.remove_logo='N' and a.status='1'
			<if test="user_id != null and user_id != ''">
				and b.user_id = #{user_id}
			</if>
			<if test="user_type != null and user_type != ''">
				and b.user_type = #{user_type}
			</if>
		ORDER BY
			a.create_time DESC
		LIMIT 1	
	</select>
	
		<!-- 查询系统消未息数量 -->
		<select id="findMessageNum" parameterType="pd" resultType="Integer">
		SELECT count(0)
			FROM common_message a
		LEFT JOIN common_message_user b on a.id=b.message_id
			where a.remove_logo='N' and a.status='1' and b.status='N'
			<if test="user_id != null and user_id != ''">
				and b.user_id = #{user_id}
			</if>
			<if test="user_type != null and user_type != ''">
				and b.user_type = #{user_type}
			</if>
	
	</select>
	
	<!-- 查询家人进出安全岛 -->
	<select id="findDeviceOneInfo" parameterType="pd" resultType="pd">
		SELECT
			a.id,
			a.customer_id,
			a.customer_sn,
			a.type,
			a.create_time,
			a.status,
			a.update_time
			FROM
			customer_safearea a
		LEFT JOIN customer_family_device b on a.customer_sn =b.sn
			 where a.status ='N' and b.family_id=#{family_id}
		ORDER BY
			a.create_time DESC
		LIMIT 1
	</select>
	
	<!-- 家人进出安全岛未读消息 -->
	<select id="findDeviceNum" parameterType="pd" resultType="Integer">
		SELECT
			count(0)
			FROM
			customer_safearea a
		LEFT JOIN customer_family_device b on a.customer_sn =b.sn
			 where a.status ='N' and b.family_id=#{family_id}
		
	</select>
	
	<!-- 查询通知（订单） -->
	<select id="findOrderOneInfo" parameterType="pd" resultType="pd">
		SELECT
			a.id,
			a.order_no,
			a.status,
			a.is_read,
			a.operator_id,
			a.operator_name,
			a.create_time,
			a.remark
		FROM
			customer_order_flow a
			LEFT JOIN customer_order b on a.order_no=b.order_no
			LEFT JOIN customer_family_device c on c.sn=b.customer_sn
		where c.family_id=#{family_id} and b.remove_logo='N' and a.is_read='N'
				<if test="statusTwo != null and statusTwo != ''">
				and (a.status = #{statusTwo} OR a.status = #{statusThree} OR a.status = #{statusFour})
			</if>
			ORDER BY
				a.create_time DESC
			LIMIT 1
	</select>
	
		<!-- 查询通知（订单）未读的数量 -->
	<select id="findOrderNum" parameterType="pd" resultType="Integer">
		SELECT
			count(0)
		FROM
			customer_order_flow a
			LEFT JOIN customer_order b on a.order_no=b.order_no
			LEFT JOIN customer_family_device c on c.sn=b.customer_sn
		where c.family_id=#{family_id} and b.remove_logo='N' and a.is_read='N'
		<if test="statusTwo != null and statusTwo != ''">
				and (a.status = #{statusTwo} OR a.status = #{statusThree} OR a.status = #{statusFour})
		</if>
		
	</select>
	
	<!-- 系统通知列表 -->
	<select id="findmessageList" parameterType="pd" resultType="pd">
		SELECT
			a.id,
			a.title,
			a.source,
			a.recipients_id,
			a.recipients_name,
			a.remark,
			a.content,
			b.update_time,
			b.id as "userId",
			b.status
			FROM common_message a
		LEFT JOIN common_message_user b on a.id=b.message_id
			where a.remove_logo='N' and a.status='1'
			<if test="user_id != null and user_id != ''">
				and b.user_id = #{user_id}
			</if>
			<if test="user_type != null and user_type != ''">
				and b.user_type = #{user_type}
			</if>
	ORDER BY
			b.status,b.update_time
			<if test="endPage != null and endPage != ''">
	   			limit #{startPage},#{endPage}
   			</if>
	</select>
	<!-- 消息列表数量 -->
		<select id="findMessageListNum" parameterType="pd" resultType="Integer">
		SELECT
			count(0)
			FROM common_message a
		LEFT JOIN common_message_user b on a.id=b.message_id
			where a.remove_logo='N' and a.status='1'
			<if test="user_id != null and user_id != ''">
				and b.user_id = #{user_id}
			</if>
			<if test="user_type != null and user_type != ''">
				and b.user_type = #{user_type}
			</if>
	
	</select>
	
	<!-- 消息详情 -->
	<select id="findMessageInfo"  parameterType="pd" resultType="pd">
		SELECT
			a.id,
			a.title,
			a.source,
			a.recipients_id,
			a.recipients_name,
			a.remark,
			a.content,
			b.update_time,
			b.status
			FROM common_message a
		LEFT JOIN common_message_user b on a.id=b.message_id
			where a.remove_logo='N' and a.status='1' and a.id=#{id}
			<if test="user_id != null and user_id != ''">
				and b.user_id = #{user_id}
			</if>
			<if test="user_type != null and user_type != ''">
				and b.user_type = #{user_type}
			</if>
	</select>
	
	<!-- 未读订单列表 -->
	<select id="findOrderList" parameterType="pd" resultType="pd">
		SELECT
			a.id as "flowId",
			a.order_no,
			a.status,
			a.is_read,
			a.operator_id,
			a.operator_name,
			a.create_time,
			b.id,
			b.order_source,
			b.server_category_name,
			d.head_address,
			a.remark
		FROM
			customer_order_flow a
			LEFT JOIN customer_order b on a.order_no=b.order_no
			LEFT JOIN customer_family_device c on c.sn=b.customer_sn
			LEFT JOIN customer_user d on c.device_id=d.device_id
		where c.family_id=#{family_id} and b.remove_logo='N'and a.is_read='N'
			<if test="statusTwo != null and statusTwo != ''">
				and (a.status = #{statusTwo} OR a.status = #{statusThree} OR a.status = #{statusFour})
			</if>
		ORDER BY a.create_time desc
		<if test="endPage != null and endPage != ''">
	   			limit #{startPage},#{endPage}
   		</if>
   		
	</select>
	
	<!-- 进出安全岛的消息列表 -->
		<select id="findDeviceList" parameterType="pd" resultType="pd">
			SELECT
				a.id,
				a.customer_id as "customer_id",
				a.customer_sn as "customer_sn",
				a.type,
				a.create_time as "create_time",
				a.status,
				b.relationship,
				c.head_address,
				c.name as "name"
				<!-- 可以注掉 
				d.lat,
				d.lon-->
				<!-- 可以注掉结束 -->
			FROM
				(select * from customer_safearea ORDER BY
				create_time DESC) a
			LEFT JOIN customer_family_device b on a.customer_sn =b.sn
			LEFT JOIN customer_user c on b.sn=c.sn
			<!-- 可以注掉 
				LEFT JOIN customer_footprint d on a.customer_sn=d.customer_sn-->
			<!-- 可以注掉结束 -->
				where b.family_id=#{family_id}
				<if test="create_time != null and create_time != ''">
					and a.create_time like concat( #{create_time},'%')
				</if>
				GROUP BY customer_id
							
	</select>
	
	<!-- 进出安全岛的未读消息详情 -->
		<select id="findDeviceInfo" parameterType="pd" resultType="pd">
		SELECT
			a.id,
			a.customer_id,
			a.customer_sn,
			a.type,
			a.create_time,
			a.status,
			a.update_time
			FROM
			customer_safearea a
		LEFT JOIN customer_family_device b on a.customer_sn =b.sn
			 where a.status ='N' and b.family_id=#{family_id} and a.id=#{id}
	</select>
	
	<!-- 消息的修改状态 -->
	<update id="updateMessage" parameterType="pd">
		update common_message_user set
			<if test="status != null and status != '' ">
				status=#{status},
			</if>
			update_time=NOW()
    		where id=#{id} 
	</update>
	
	<!-- 修改安全岛状态 -->
	<update id="updateDevice" parameterType="pd">
		update customer_safearea set
			<if test="status != null and status != '' ">
				status=#{status},
			</if>
			update_time=NOW()
    		where id=#{id} 
	</update>
	
	<!-- 修改订单消息状态 -->
	<update id="updateOrder" parameterType="pd">
		update customer_order_flow set
			<if test="is_read != null and is_read != '' ">
				is_read=#{is_read}
			</if>
    		where id=#{id} 
	</update>
	
	<!-- 关于我们 、注册-->
	<select id="findUsInfo" parameterType="pd" resultType="pd">
		SELECT
			a.id as "id",
			a.title as "title",
			a.publish_content as "publish_content"
		FROM
			app_common_info a
		where 1=1
			<if test="info_type != null and info_type != ''">
				and a.info_type = #{info_type}
			</if>
			<if test="user_type != null and user_type != ''">
				and a.user_type = #{user_type}
			</if>
	
	</select>
	
	<!-- 历史足迹 -->
	<select id="findEmpreinteList" parameterType="pd" resultType="pd">
		SELECT
			a.id,
			a.customer_sn,
			a.lon,
			a.lat,
			a.end_time,
			a.customer_id
		FROM
			customer_footprint a
			 where a.customer_id=#{customer_id}
			 	<if test="create_time != null and create_time != ''">
					and a.create_time like concat( #{create_time},'%')
				</if>
	ORDER BY end_time desc 
	</select>
		
		<!-- 修改手机号、（也就是登录名） -->
		<update id="updateUser" parameterType="pd">
			update app_users set
			<if test="login_name != null and login_name != '' ">
				login_name=#{login_name},
			</if>
			<if test="phone != null and phone != '' ">
				phone=#{phone},
			</if>
			update_time=NOW()
    		where id=#{id} 
		</update>
		
		<!-- 查询apk最新版本 -->
		<select id="findApkInfo" parameterType="pd" resultType="pd">
			SELECT
				a.id,
				a.device_type,
				a.type,
				a.title,
				a.content,
				a.version_code,
				a.file_address,
				a.remark
			FROM
				common_apkversion a
			where 1=1 and a.status='Y' and a.remove_logo='N' 
				<if test="device_type != null and device_type != ''">
					and a.device_type = #{device_type}
				</if>
				<if test="type != null and type != ''">
					and a.type = #{type}
				</if>
				ORDER BY
					a.update_time DESC
				LIMIT 1 
		</select>
		
		<!--商户版消息  -->
		<select id="findMessageShList" parameterType="pd" resultType="pd">
				SELECT
					b.id as "flowId",
					b.order_no,
					b.`status`,
					a.server_category_name,
					b.is_read,
					b.remark,
					c.head_address,
					b.create_time,
					a.order_source,
					a.id
					FROM
					customer_order a 
					LEFT JOIN customer_order_flow b on a.order_no=b.order_no
					LEFT JOIN app_users c on c.id=a.server_user_id
				where a.remove_logo='N' and b.is_read='N' and a.server_user_id=#{server_user_id}
				<if test="statusTwo != null and statusTwo != ''">
				and (a.status = #{statusTwo} OR a.status = #{statusThree} OR a.status = #{statusFour})
			</if>
				ORDER BY b.create_time desc
		</select>
		
		<!-- 商户版的消息数量 -->
			<select id="findMessageShNum" parameterType="pd" resultType="Integer">
				SELECT
					count(0)
					FROM
					customer_order a 
					LEFT JOIN customer_order_flow b on a.order_no=b.order_no
					LEFT JOIN app_users c on c.id=a.server_user_id
				where a.remove_logo='N' and b.is_read='N' and a.server_user_id=#{server_user_id}
					<if test="statusTwo != null and statusTwo != ''">
				and (a.status = #{statusTwo} OR a.status = #{statusThree} OR a.status = #{statusFour})
			</if>
		</select>
		
		<!-- 商户订单最新消息 -->
		<select id="findShOrderInfo" parameterType="pd" resultType="pd">
				SELECT
					b.id as "flowId",
					b.order_no,
					b.`status`,
					b.is_read,
					b.remark,
					a.server_category_name,
					c.head_address,
					b.create_time,
					a.order_source,
					a.id 
					FROM
					customer_order a 
					LEFT JOIN customer_order_flow b on a.order_no=b.order_no
					LEFT JOIN app_users c on c.id=a.server_user_id
				where a.remove_logo='N' and b.is_read='N' and a.server_user_id=#{server_user_id}
					<if test="statusTwo != null and statusTwo != ''">
				and (a.status = #{statusTwo} OR a.status = #{statusThree}  OR a.status = #{statusFour})
			</if>
				ORDER BY
					b.create_time DESC
				LIMIT 1 
		</select>
		
		
</mapper>