<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecare.web.system.user">
    
	<!--查询信息列表-->
    <select id="findListPage" resultType="pd" parameterType="page">
		SELECT
		a.id,
		a.login_name,
		a.login_password,
		a.user_name,
		a.sex,
		a.email,
		a.phone,
		a.birth_date,
		a.live_address,
		a.birth_address,
		a.head_address,
		a.digital_account,
		a.type,
		a.order_by,
		a.`status`,
		a.remark,
		a.organize_id,
		a.remove_logo,
		a.create_user,
		a.create_time,
		a.update_time,
		a.wearth_city_id,
		a.session_id,
		a.partner_type,
		d.name AS organizeName
		FROM
		system_user a
		LEFT JOIN system_user_organize b ON a.id = b.user_id
		LEFT JOIN system_organize d ON b.organize_id = d.id
    	 where 1=1
    	 <if test="pd.remove_logo != null and pd.remove_logo != ''"><!-- 状态检索 -->
			and a.remove_logo=#{pd.remove_logo}
		</if>
    	 <if test="pd.login_name != null and pd.login_name != ''"><!-- 登录名称检索 -->
			and a.login_name like concat('%', #{pd.login_name},'%')
		</if>
		<if test="pd.user_name != null and pd.user_name != ''"><!-- 用户名检索 -->
			and a.user_name like concat('%', #{pd.user_name},'%')
		</if>
		<if test="pd.status != null and pd.status != ''"><!-- 状态检索 -->
			and a.status=#{pd.status}
		</if>
		<if test="pd.type != null and pd.type != ''"><!-- 类型检索 -->
			and a.type=#{pd.type}
		</if>
		order by a.order_by asc, a.create_time desc
    </select>
	<select id="findList" resultType="pd" parameterType="pd">
		SELECT id FROM system_user WHERE remove_logo = 'N' AND `status` = 'Y'
	</select>
	<!--查询信息详情-->
    <select id="findInfo" resultType="pd" parameterType="pd">
		SELECT
			a.id,
			a.login_name,
			a.login_password,
			a.user_name,
			a.sex,
			a.email,
			a.phone,
			a.birth_date,
			a.live_address,
			a.birth_address,
			a.head_address,
			a.digital_account,
			a.type,
			a.order_by,
			a.`status`,
			a.remark,
			a.organize_id,
			a.remove_logo,
			a.create_user,
			a.create_time,
			a.update_time,
			a.wearth_city_id,
			a.session_id,
			a.partner_type,
			d.name AS organizeName
		FROM
		system_user a
		LEFT JOIN system_user_organize b ON a.id = b.user_id
		LEFT JOIN system_organize d ON b.organize_id = d.id
    	 where 1=1
    	 <if test="id != null and id != '' ">
			and a.id=#{id}
		</if>
		<if test="login_name != null and login_name != '' ">
			and a.login_name=#{login_name}
		</if>
    </select>
    
    
    <!--保存信息-->
    <insert id="save" parameterType="pd">
    	insert into system_user (
    			login_name,
    			login_password,
    			user_name,
    			sex,
    			email,
    			phone,
    			head_address,
    			digital_account,
    			type,
    			order_by,
    			status,
    			remark,
    			remove_logo,
    			create_user,
    			create_time,
    			update_time,
    			wearth_city_id) 
    		values (
				#{login_name},
				#{login_password},
				#{user_name},
				#{sex},
				#{email},
				#{phone},
				#{head_address},
				#{digital_account},
				#{type},
				#{order_by},
				#{status},
				#{remark},
				#{remove_logo},
				#{create_user},
				#{create_time},
				#{update_time},
				#{wearth_city_id})
    </insert>
    
    
	<!--更新信息-->
    <update id="update" parameterType="pd">
    	update system_user set 
    		<if test="login_name != null and login_name != '' ">
				login_name=#{login_name},
			</if>
			<if test="login_password != null and login_password != '' ">
				login_password=#{login_password},
			</if>
			<if test="user_name != null and user_name != '' ">
				user_name=#{user_name},
			</if>
			<if test="sex != null and sex != '' ">
				sex=#{sex},
			</if>
			<if test="head_address != null and head_address != '' ">
				head_address=#{head_address},
			</if>
			<if test="email != null and email != '' ">
				email=#{email},
			</if>
			<if test="phone != null and phone != '' ">
				phone=#{phone},
			</if>
			<if test="head_address != null and head_address != '' ">
				head_address=#{head_address},
			</if>
			<if test="digital_account != null and digital_account != '' ">
				digital_account=#{digital_account},
			</if>
			<if test="type != null and type != '' ">
				type=#{type},
			</if>
			<if test="order_by != null and order_by != '' ">
				order_by=#{order_by},
			</if>
			<if test="status != null and status != '' ">
				status=#{status},
			</if>
			<if test="remark != null and remark != '' ">
				remark=#{remark},
			</if>
    		<if test="remove_logo != null and remove_logo != '' ">
				remove_logo=#{remove_logo},
			</if>
			<if test="wearth_city_id != null and wearth_city_id != '' ">
				wearth_city_id=#{wearth_city_id},
			</if>
    		update_time=#{update_time}
    		where id=#{id}
    		
    </update>
    
    
	<!--删除信息-->
    <delete id="delete" parameterType="String">
    	delete from system_user where id=#{id}
    </delete>
    
    
	<!--查询已删除信息数量-->
    <select id="findDelNum" parameterType="pd" resultType="Integer">
    	select count(*) from system_user where remove_logo='Y' 
			and type=#{type}
    </select>
    
	<!--删除用户组织信息-->
    <delete id="deleteUserOrganize" parameterType="String">
    	delete from system_user_organize where user_id=#{id}
    </delete>
    
	<!--删除用户角色信息-->
     <delete id="deleteUserRole" parameterType="String">
    	delete from system_user_role where user_id=#{id}
    </delete>
    
	<!--查询已删除用户ids-->
    <select id="findListIds" parameterType="pd" resultType="Integer">
    	select 
    		a.id as "id"
    	 from system_user a
    	 where a.remove_logo='Y'
    	 and a.type=#{type}
    </select>
    
    <select id="findRoleList" parameterType="pd" resultType="pd">
    	select
    		a.id as "id",
    		a.name as "name",
    		a.short_name as "short_name"
    		from system_role a
    		where a.remove_logo='N'
    		order by order_by asc,create_time desc
    </select>
    

    <select id="findUserRoleList" parameterType="pd" resultType="pd">
    	select 
    		a.id as "id",
    		a.user_id as "user_id",
    		a.role_id as "role_id",
    		b.name as "name",
    		b.short_name as "short_name"
    		from system_user_role a
    		left join system_role b on a.role_id=b.id
    		where a.user_id=#{user_id}
    </select>
    
    
    <delete id="delUserRole" parameterType="pd">
    	delete from system_user_role where user_id=#{user_id}
    </delete>
    
    
    <insert id="saveUserRole" parameterType="pd">
    	insert into system_user_role (user_id,role_id,create_user,create_time)
    		values
    		(#{user_id},#{role_id},#{create_user},#{create_time})
    </insert>
    
    
    <select id="findOraganizeList" parameterType="pd" resultType="pd">
    	select
    		a.id as "id",
    		a.name as "name",
    		a.parent_id as "pId",
    		if(b.id is null,"false","true") as "checked"
    		from system_organize a
    		left join system_user_organize b on a.id=b.organize_id and b.user_id=#{user_id}
    		where 1=1
    		<if test="remove_logo != null and remove_logo != ''">
				and a.remove_logo =#{remove_logo} 
			</if>
    		order by a.order_by asc,a.create_time desc
    </select>
    
    
    <delete id="delOrganize" parameterType="pd">
    	delete from system_user_organize where user_id=#{user_id}
    </delete>
    
    
    <insert id="saveOrganize" parameterType="pd">
    	insert into system_user_organize (user_id,organize_id,create_user,create_time)
    		values
    		(#{user_id},#{organize_id},#{create_user},#{create_time})
    </insert>
    
    
</mapper>