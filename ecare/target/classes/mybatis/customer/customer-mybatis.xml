<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecare.web.customer.customer">


    <!--查询信息列表-->
    <select id="findListPage" resultType="pd" parameterType="page">
    	select
    		a.id as "id",
    		a.device_id as "device_id",
    		a.sn as "sn",
    		a.name as "name",
    		a.sex as "sex",
    		a.phone as "phone",
    		a.birthday as "birthday",
    		a.address as "address",
    		a.health_condition as "health_condition",
    		a.head_address as "head_address",
    		a.remark as "remark",
    		a.status as "status",
    		a.remove_logo as "remove_logo",
    		a.create_user as "create_user",
    		a.create_time as "create_time",
    		a.update_time as "update_time"
    		from customer_user a
    		where 1=1
    		<if test="pd.device_id != null and pd.device_id != ''"><!-- 状态检索 -->
	            and a.device_id=#{pd.device_id}
	        </if>
	        <if test="pd.remove_logo != null and pd.remove_logo != ''"><!-- 状态检索 -->
	            and a.remove_logo=#{pd.remove_logo}
	        </if>
	        <if test="pd.sn != null and pd.sn != ''"><!-- 用户名检索 -->
	            and a.sn=#{pd.sn}
	        </if>
	        <if test="pd.name != null and pd.name != ''"><!-- 登录名称检索 -->
	            and a.name like concat('%', #{pd.name},'%')
	        </if>
	        order by a.create_time desc
    </select>

	<!--查询信息列表-->
	<select id="findList" parameterType="pd" resultType="pd">
		select
		a.id as "id",
		a.device_id as "device_id",
		a.sn as "sn",
		a.name as "name",
		a.sex as "sex",
		a.phone as "phone",
		a.birthday as "birthday",
		a.address as "address",
		a.health_condition as "health_condition",
		a.head_address as "head_address",
		a.remark as "remark",
		a.status as "status",
		a.remove_logo as "remove_logo",
		a.create_user as "create_user",
		a.create_time as "create_time",
		a.update_time as "update_time"
		from customer_user a
		where 1=1
		<if test="device_id != null and device_id != ''"><!-- 状态检索 -->
			and a.device_id=#{device_id}
		</if>
		<if test="remove_logo != null and remove_logo != ''"><!-- 状态检索 -->
			and a.remove_logo=#{remove_logo}
		</if>
		<if test="sn != null and sn != ''"><!-- 用户名检索 -->
			and a.sn like concat('%', #{sn},'%')
		</if>
		<if test="name != null and name != ''"><!-- 登录名称检索 -->
			and a.name like concat('%', #{name},'%')
		</if>
		order by a.create_time desc
	</select>
    <select id="findInfo" parameterType="pd" resultType="pd">
		SELECT
			a.id AS id,
			a.device_id AS device_id,
			a.sn AS sn,
			a.`name` AS `name`,
			a.sex AS sex,
			a.phone AS phone,
			a.birthday AS birthday,
			a.address AS address,
			a.health_condition AS health_condition,
			a.head_address AS head_address,
			a.remark AS remark,
			a.`status` AS `status`,
			a.remove_logo AS remove_logo,
			a.create_user AS create_user,
			a.create_time AS create_time,
			a.update_time AS update_time,
			b.app_id AS "app_id",
			b.secret AS "secret"
		from customer_user a
		LEFT JOIN customer_device b
		ON a.sn = b.sn
		where 1=1
    		<if test="id != null and id != ''"><!-- 状态检索 -->
	            and a.id=#{id}
	        </if>
	        <if test="device_id != null and device_id != ''"><!-- 状态检索 -->
	            and a.device_id=#{device_id}
	        </if>
	        <if test="sn != null and sn != ''"><!-- 状态检索 -->
	            and a.sn=#{sn}
	        </if>
    </select>
    
    
    <!--保存信息-->
    <insert id="save" parameterType="pd">
        insert into customer_user (
	        device_id,
	        sn,
	        name,
	        sex,
	        phone,
	        birthday,
	        address,
	        health_condition,
	        head_address,
	        remark,
	        status,
	        remove_logo,
	        create_user,
	        create_time,
	        update_time
	        )
	        values (
	        #{device_id},
	        #{sn},
	        #{name},
	        #{sex},
	        #{phone},
	        #{birthday},
	        #{address},
	        #{health_condition},
	        #{head_address},
	        #{remark},
	        #{status},
	        #{remove_logo},
	        #{create_user},
	        #{create_time},
	        #{update_time})
    </insert>


    <!--更新信息-->
    <update id="update" parameterType="pd">
        update customer_user set
        <if test="device_id != null and device_id != '' ">
            device_id=#{device_id},
        </if>
        <if test="sn != null and sn != '' ">
            sn=#{sn},
        </if>
        <if test="name != null and name != '' ">
            name=#{name},
        </if>
        <if test="sex != null and sex != '' ">
            sex=#{sex},
        </if>
        <if test="phone != null and phone != '' ">
            phone=#{phone},
        </if>
        <if test="birthday != null and birthday != '' ">
            birthday=#{birthday},
        </if>
        <if test="address != null and address != '' ">
            address=#{address},
        </if>
        <if test="health_condition != null and health_condition != '' ">
            health_condition=#{health_condition},
        </if>
        <if test="head_address != null and head_address != '' ">
            head_address=#{head_address},
        </if>
        <if test="remark != null and remark != '' ">
            remark=#{remark},
        </if>
        <if test="status != null and status != '' ">
            status=#{status},
        </if>
        <if test="remove_logo != null and remove_logo != '' ">
            remove_logo=#{remove_logo},
        </if>
        update_time=#{update_time}
        where id=#{id}
    </update>
    
    
    <update id="removeDevice" parameterType="pd">
    	 update customer_user set
            device_id=#{device_id},
            sn=#{sn},
            update_time=#{update_time}
        	where id=#{id}
    </update>

    <!--删除信息-->
    <delete id="delete" parameterType="String">
        delete from customer_user where id=#{id}
    </delete>
    
    
	<!--查询已删除信息数量-->
    <select id="findDelNum" parameterType="pd" resultType="Integer">
    	select count(*) from customer_user where remove_logo='Y'
    </select>
    
    
    <!--查询已删除用户ids-->
    <select id="findListIds" parameterType="pd" resultType="Integer">
    	select 
    		a.id as "id"
    	 from customer_user a
    	 where a.remove_logo='Y'
    </select>
    
    
    <update id="updateDeviceStatus" parameterType="pd">
    	update customer_device set status=#{status},update_time=#{update_time} where id=#{id}
    </update>
    
    
    <select id="findFootprint" parameterType="pd" resultType="pd">
    	select
    		a.id as "id",
    		a.customer_sn as "customer_sn",
    		a.customer_id as "customer_id",
    		a.lon as "lon",
    		a.lat as "lat",
    		a.loc_way as "loc_way",
    		a.start_times as "start_times",
    		a.end_time as "end_time",
    		substring(a.start_times, 11) as "time",
    		a.accuracy as "accuracy"
    		from customer_footprint a
    		where a.customer_id=#{customer_id}
    		and a.end_time LIKE #{find_time}"%"
    		order by a.start_times desc
    </select>
    
    
    <select id="findOrderFootprint" parameterType="pd" resultType="pd">
    	select
    		a.id as "id",
    		a.order_no as "order_no",
    		a.order_source as "order_source",
    		a.server_category_id as "server_category_id",
    		a.server_category_name as "server_category_name",
    		a.appointment_time as "appointment_time",
    		a.server_info_id as "server_info_id",
    		a.customer_id as "customer_id",
    		a.customer_sn as "customer_sn",
    		a.customer_phone as "customer_phone",
    		a.customer_name as "customer_name",
    		a.customer_address as "customer_address",
    		a.remark as "remark",
    		a.create_time as "create_time",
    		a.create_user as "create_user",
    		a.amount as "amount",
    		a.server_user_id as "server_user_id",
    		a.pay_type as "pay_type",
    		a.others_server as "others_server",
    		a.status as "status",
    		a.remove_logo as "remove_logo"
    		from customer_order a
    		where left(a.create_time,10)=#{find_time} and a.customer_id=#{customer_id}
    		order by a.create_time desc
    </select>

	<select id="findNum" parameterType="pd" resultType="Integer">
		SELECT
		COUNT(0) AS num
		FROM
		customer_user a
		WHERE 1=1
		<if test="remove_logo != null and remove_logo != '' ">
			AND a.remove_logo=#{remove_logo}
		</if>
	</select>
</mapper>