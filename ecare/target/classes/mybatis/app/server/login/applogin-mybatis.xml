<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecare.app.server.login">

	<!-- 判断手机号是否注册 -->
	<select id="findPhone" resultType="Integer" parameterType="pd">
		select count(*) from app_users a
		 where a.login_name =#{login_name}
	</select>

	<!-- 注册 -->
	<insert id="save" parameterType="pd">
		insert into app_users (
        login_name,
        login_password,
        status,
        phone,
        create_time,
        update_time,
        remove_logo,
        session_id,
        user_type,
        isAuthent,
        nickname)
        values (
        #{login_name},
        #{login_password},
        #{status},
        #{phone},
       	NOW(),
        NOW(),
        #{remove_logo},
        #{session_id},
        #{user_type},
        #{isAuthent},
        #{nickname})
	</insert>
	
	<!-- 注册 -->
	<insert id="saveBusiness" parameterType="pd">
		insert into app_users_authent (
        business_id,
        step,
        create_time,
        update_time)
        values (
        #{business_id},
        #{step},
        NOW(),
        NOW())
	</insert>
	
	<!-- 登录 -->
	<select id="findLoginInfo" parameterType="pd" resultType="pd">
		select
			a.id AS id,
			a.login_name AS login_name,
			a.`status` AS `status`,
			a.session_id AS session_id,
			a.login_password AS login_password,
			a.sex AS sex,
			a.nickname as "nickname",
			a.phone AS phone,
			a.live_address AS live_address,
			a.head_address AS head_address,
			a.email AS email,
			a.is_work as "is_work",
			a.isAuthent AS isAuthent,
			b.authent_name AS authent_name,
			b.partner_code AS partner_code,
			b.partner_id AS partner_id,
			b.PID AS PID,
			b.idCard_back AS idCard_back,
			b.step AS step,
			b.idCard_front AS idCard_front
		from app_users a
		left join app_users_authent b on a.id=b.business_id
		where 1=1  and a.remove_logo='N' and a.status='1'
			
			<if test="user_type != null and user_type != '' ">
				and a.user_type=#{user_type}
			</if>
			<if test="session_id != null and session_id != '' ">
				and a.session_id=#{session_id}
			</if>
			<if test="login_name != null and login_name != '' ">
				and a.login_name=#{login_name}
			</if>
	</select>

	<!--更新信息-->
    <update id="update" parameterType="pd">
    	update app_users set
    		<if test="login_name != null and login_name != '' ">
				login_name=#{login_name},
			</if>
			<if test="login_password != null and login_password != '' ">
				login_password=#{login_password},
			</if>
			
			<if test="sex != null and sex != '' ">
				sex=#{sex},
			</if>
			<if test="head_address != null and head_address != '' ">
				head_address=#{head_address},
			</if>
			<if test="email != null and email != '' ">
				email=#{email},
			</if>
			<if test="phone != null and phone != '' ">
				phone=#{phone},
			</if>
			<if test="head_address != null and head_address != '' ">
				head_address=#{head_address},
			</if>
			<if test="live_address != null and live_address != '' ">
				live_address=#{live_address},
			</if>
			<if test="birth_address != null and birth_address != '' ">
				birth_address=#{birth_address},
			</if>
			<if test="isAuthent != null and isAuthent != '' ">
				isAuthent=#{isAuthent},
			</if>
			<if test="status != null and status != '' ">
				status=#{status},
			</if>
			<if test="remark != null and remark != '' ">
				remark=#{remark},
			</if>
			<if test="session_id != null and session_id != '' ">
				session_id=#{session_id},
			</if>
    		update_time=Now()
    		where id=#{id}
    </update>
    
    
    	<!--  我的收入  -->
	<select id="findMany" parameterType="pd" resultType="Double">
		SELECT
		sum(a.amount) as "amount"
		FROM
			customer_order a
		where (a.status='5' or a.status='6') 
		and a.server_user_id=#{server_user_id}
		 <if test="month != null and month != '' ">
				and a.create_time like concat('%', #{month},'%')
		</if>
	</select>
	
	<!--订单完成量-->
	<select id="findNum" parameterType="pd" resultType="Integer">
		SELECT
			count(*)
		FROM
			customer_order a
		where (a.status='4'or a.status='5' or a.status='6')
		 and a.server_user_id=#{server_user_id} 
		 <if test="month != null and month != '' ">
				and a.create_time like concat('%', #{month},'%')
		</if>
		 
	
	</select>
    
    
    
</mapper>